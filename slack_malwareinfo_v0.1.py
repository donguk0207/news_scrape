import os
import ssl
import requests
from requests.packages.urllib3.exceptions import InsecureRequestWarning
#import slack_sdk
from slack_sdk import WebClient
from bs4 import BeautifulSoup
from selenium import webdriver
from selenium.webdriver.chrome.options import Options
from selenium.webdriver.support.ui import WebDriverWait
from datetime import datetime, timedelta, timezone
import time
import warnings
from urllib3.exceptions import InsecureRequestWarning

ssl._create_default_https_context = ssl._create_unverified_context
requests.packages.urllib3.disable_warnings(InsecureRequestWarning)
warnings.filterwarnings("ignore", category=InsecureRequestWarning)

class NewsScraper:
    def __init__(self):
        self.options = Options()
        user_agent = "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/112.0.0.0 Safari/537.36 Edg/112.0.1722.48"
        self.options.add_experimental_option("prefs", {"safebrowsing.enabled": True})
        self.options.add_experimental_option("detach", True)
        self.options.add_argument("--start-maximized")
        self.options.add_argument('user-agent=' + user_agent)
        self.driver = webdriver.Chrome('chromedriver', options=self.options)
        self.wait = WebDriverWait(self.driver, 60)

    def parse_date(self, date):
        try:
            return datetime.strptime(date, "%Y-%m-%dT%H:%M:%S%z")
        except ValueError:
            print(f"날짜 형식이 일치하지 않습니다: {date}")
            return datetime.now()

    def scrape_news_articles(self):
        base_url = "https://asec.ahnlab.com"
        url = "https://asec.ahnlab.com/ko/category/malware-information"
        self.driver.get(url)

        soup = BeautifulSoup(self.driver.page_source, 'html.parser')
        news_blocks = soup.select('article.post-archive')

        articles = []

        for news_block in news_blocks:
            image_url = news_block.select_one('a.thumbnail')['style'].split('(')[1].split(')')[0]
            date = news_block.select_one('div.postmetadata time.entry-date')['datetime']
            article_title = news_block.select_one('h2.posttitle a').text.strip()
            article_url = news_block.select_one('h2.posttitle a')['href']
            article_content = news_block.select_one('p a.excerpt').text.strip()

            article_date = self.parse_date(date)
            if article_date and datetime.now(timezone.utc) - article_date < timedelta(hours=2):
                formatted_date = article_date.strftime("%Y-%m-%d %H:%M")
                article = {
                    '이미지_경로': image_url,
                    '제목': article_title,
                    '내용': article_content,
                    'Link': article_url,
                    '작성일자': formatted_date
                }
                articles.append(article)

        return articles

    def send_to_slack(self, articles):
        slack_token = '*'
        client = WebClient(token=slack_token)
        channel = 'C06EM6X5E1H'

        for article_item in articles:
            try:
                formatted_date = article_item.get('작성일자')
                message = {
                    "blocks": [
                        {"type": "divider"},
                        {
                            "type": "header",
                            "text": {
                                "type": "plain_text",
                                "text": f"{article_item.get('제목', '')}",
                                "emoji": True
                            }
                        },
                        {
                            "type": "section",
                            "text": {
                                "type": "mrkdwn",
                                "text": f"{article_item.get('내용', '')}\n{article_item.get('Link', '')}\n{formatted_date}"
                            },
                            "accessory": {
                                "type": "image",
                                "image_url": f"{article_item.get('이미지_경로', '')}",
                                "alt_text": "Image"
                            }
                        },
                        {"type": "divider"}
                    ]
                }

                response = client.chat_postMessage(channel=channel, blocks=message['blocks'])
                print(response)

            except Exception as e:
                print(f"Slack으로의 발송 중 에러 발생: {str(e)}")

if __name__ == "__main__":
    scraper = NewsScraper()
    while True:
        print(f"현재 수집 중인 시각: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}")
        articles = scraper.scrape_news_articles()

        for article in articles:
            print(f"◈제목: {article.get('제목', '')}\n◈내용: {article.get('내용', '')}\n◈Link: {article.get('Link', '')}\n◈작성일자: {article.get('작성일자', '')}\n")

        scraper.send_to_slack(articles)
        time.sleep(7200)
